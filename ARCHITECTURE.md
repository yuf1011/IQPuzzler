# ARCHITECTURE.md — IQ Puzzler Pro Technical Architecture

## Module Overview

```
index.html          Entry point — minimal HTML skeleton
    ↓ imports
game.js             Main game logic, UI rendering, interaction handling
    ↓ imports
pieces.js           Piece definitions, transformations, orientation precomputation
```

```
style.css           All visual styles (loaded by index.html)
```

No build step, no bundler, no external dependencies. Pure ES modules.

---

## pieces.js — Data & Transformation Layer

### Exports

| Export | Type | Description |
|--------|------|-------------|
| `PIECES` | `Array<{id, name, color, shape}>` | 12 frozen piece definitions |
| `PIECE_MAP` | `{[id]: piece}` | Quick lookup by ID |
| `ORIENTATIONS` | `{[id]: shape[]}` | Precomputed unique orientations per piece |
| `normalize(shape)` | `fn → shape` | Translate to origin, sort canonically |
| `rotate90CW(shape)` | `fn → shape` | Rotate 90° clockwise |
| `flipH(shape)` | `fn → shape` | Horizontal mirror |
| `shapeKey(shape)` | `fn → string` | String key for deduplication |
| `getAllOrientations(shape)` | `fn → shape[]` | All unique orientations (max 8) |
| `makeBallGradient(hex)` | `fn → string` | CSS radial-gradient for 3D ball |
| `lighten(hex, pct)` | `fn → hex` | Lighten a hex color |
| `darken(hex, pct)` | `fn → hex` | Darken a hex color |

### Coordinate Convention

Shapes use `[col, row]` pairs. `(0,0)` = top-left of bounding box.

```
col →
row   (0,0) (1,0) (2,0)
↓           (1,1) (2,1)
                  (2,2)
```

### Transformation Math

- **Rotate 90° CW**: `(c, r) → (maxRow - r, c)` then normalize
- **Flip horizontal**: `(c, r) → (maxCol - c, r)` then normalize
- **Normalize**: subtract min col/row, sort by (row, col)

### Orientation Precomputation

For each piece, generate all 8 transforms (4 rotations × 2 flips), deduplicate by `shapeKey`. Results are frozen at module load time.

Expected counts:
- K (square): 1
- L (line): 2
- A, C, B, E, I, J: 4
- D, F, G, H: 8

### Ball Count Validation

Module throws at load time if total ≠ 55.

---

## game.js — Game Logic & UI Layer

### State Object

```js
state = {
  board:    // number[][] — 5×11, null or pieceId
  placed:   // Map<pieceId, {col, row, orientationIndex, shape}>
  tray:     // Set<pieceId> — available pieces
  selected: // {id, orientationIndex, shape} | null
  preview:  // {col, row, valid} | null
  mode:     // 'idle' | 'selected' | 'dragging'
}
```

Board access: `state.board[row][col]` — **row first, then col**.

### Interaction State Machine

```
                click tray
    ┌──────┐ ───────────► ┌──────────┐
    │ IDLE │               │ SELECTED │
    └──────┘ ◄─────────── └──────────┘
              Esc/toggle      │
                              │ click board (valid)
                              ▼
                          ┌──────┐
                          │ IDLE │ (piece placed)
                          └──────┘

              pointerdown + move
    ┌──────┐ ────────────────► ┌──────────┐
    │ IDLE │                    │ DRAGGING │
    └──────┘                    └──────────┘
                                │ pointerup (valid) → place → IDLE
                                │ pointerup (invalid) → cancel → IDLE
```

### DOM Structure (generated by JS)

```
#board-grid
  └─ .board-cell[data-row][data-col] × 55
       classes: .occupied, .preview-valid, .preview-invalid, .flash
       data-piece="A" (when occupied)

#piece-tray
  └─ .tray-piece[data-piece-id] × 12
       classes: .selected, .placed
       └─ .tray-shape (CSS Grid)
            └─ .tray-ball / .tray-empty
       └─ .tray-label

.ghost-piece (appended to body)
  └─ .ghost-ball × n (matches current orientation)
```

### Event Flow

| Event | Target | Handler |
|-------|--------|---------|
| `click` | `#board-grid` | Place piece or remove placed piece |
| `click` | `#piece-tray` | Select/deselect piece |
| `pointerdown` | `#piece-tray` | Start drag tracking |
| `pointermove` | `document` | Drag / ghost follow / board preview |
| `pointerup` | `document` | End drag, place or cancel |
| `keydown` | `document` | R=rotate, F=flip, Esc=deselect |
| `contextmenu` | `document` | Right-click=flip |

### Rendering Strategy

1. **Initial render**: Build DOM once (`renderBoard`, `renderTray`, `createGhost`)
2. **Updates**: Surgical class/style changes on existing elements
   - `updateBoardDisplay()`: Set background gradient + classes on all 55 cells
   - `updateTrayDisplay()`: Toggle `.placed` / `.selected` classes
   - `showBoardPreview()` / `clearBoardPreview()`: Toggle preview classes
   - `updateGhostShape()`: Rebuild ghost grid on rotate/flip

### Ghost Positioning

Ghost uses `position: fixed` with `pointer-events: none` (allows `elementFromPoint` to see through it). Centered on cursor.

### Win Detection

`isBoardFull()` checks every cell after each placement. On win:
1. Board gets `.win` class (pulse animation)
2. Overlay with message + "Play Again" button

---

## style.css — Visual Architecture

### Layout

- `.game-container`: CSS Grid, 2 columns (board | sidebar)
- `.board-grid`: CSS Grid, 11 cols × 5 rows
- `.piece-tray`: CSS Grid, auto-fill wrapping
- Responsive breakpoints at 900px, 600px, 450px

### 3D Ball Effect

`radial-gradient(circle at 35% 35%, lighten 0%, base 50%, darken 100%)`
plus a `::after` pseudo-element for specular highlight dot.

### CSS Custom Properties

All sizing (`--cell-size`, `--cell-gap`, `--tray-cell-size`) and colors are defined as custom properties on `:root` for easy theming and responsive adjustment.

---

## Future Extensions (P1/P2)

| Feature | File | Notes |
|---------|------|-------|
| Challenge mode | `challenges.js` + game.js | Pre-placed locked pieces |
| Backtracking solver | `solver.js` | Fill top-left-first, prune islands |
| Hint system | game.js + solver.js | Place next correct piece |
| Timer | game.js | `performance.now()` based |
| Local storage | game.js | Save/load progress |
